# 风控管理页面

## 页面概述
风控管理页面是用户配置和监控交易风险控制规则的中心界面，为交易策略提供全面的风险防范机制。此页面涵盖系统级风控条件、账户安全风控、市场风险风控、技术风控和时间风控等多层次的风险管理功能，帮助用户防范市场波动和技术因素带来的交易风险，保障用户资产安全。

## 功能点
1. **系统风控条件**：
   - 最大持仓币种数限制
   - 最大持仓价值限制
   - 最大亏损停止阈值设置
   - 紧急停止所有交易功能

2. **账户安全风控**：
   - 设置单位时间内最大亏损限制
   - 按小时、天、周等时间单位灵活配置

3. **市场风险风控**：
   - 价格异常波动监控与阈值设置
   - 波动监控时间窗口配置
   - 波动计算方式选择
   - 流动性监控与滑点控制

4. **技术风控**：
   - API响应超时监控
   - 交易所连接状态监控
   - 自动重连尝试配置

5. **时间风控**：
   - 交易时间限制（日期、时间段）
   - 重要时间点禁止交易（如重要数据发布时间）
   - 灵活配置一次性或永久性时间规则

6. **风控历史记录**：
   - 查看历史风控触发事件
   - 分析触发原因和采取的动作

## 用户流程
1. 用户进入风控管理页面，查看当前风控状态概览
2. 配置系统级风控条件，如最大持仓数量和亏损限制
3. 设置各类风控规则，包括账户、市场、技术和时间风控
4. 可随时查看风控触发历史记录进行分析
5. 保存配置或根据需要恢复默认设置
6. 遇紧急情况可一键停止所有交易活动

## 线框图

```
+--------------------------------------------------------------+
|                                                              |
|  系统风控管理                     [紧急停止所有交易]          |
|                                                              |
+--------------------------------------------------------------+
|                                                              |
|  系统风控条件                                                |
|  +---------------------+ +---------------------+ +----------+ |
|  | 最大持仓币种数       | | 最大持仓价值        | | 最大亏损停止 |
|  | [ 10        ▼ ]     | | [ 不限制     ▼ ]    | | [ 不限制  ▼] |
|  |                     | |                     | |            |
|  | 当前持仓: 4/10      | | 当前持仓: 20,000 USDT| | 当前: 200 USDT|
|  | [==========40%]     | |                     | |            |
|  +---------------------+ +---------------------+ +----------+ |
|                                                              |
|  账户安全风控                                                |
|  +-----------------------------------------------------------+|
|  | 最大亏损限制:                                            | |
|  | [  500  ] USDT  [ 每日 ▼ ]                               | |
|  | 单位时间内亏损达到此金额时，自动暂停相关策略              | |
|  +-----------------------------------------------------------+|
|                                                              |
|  市场风险风控                                                |
|  +-----------------------------------------------------------+|
|  | 价格异常波动监控: [开关]   波动阈值: [ 3.0 ] %            | |
|  | 短时价格波动超过此比例时触发保护                          | |
|  |                                                           | |
|  | 监控时间窗口: [ 15 ] [ 分钟 ▼ ]   计算方式: [最高价-最低价 ▼]|
|  | 指定时间窗口内监测价格波动                                | |
|  |                                                           | |
|  | 流动性监控: [开关]   最大允许滑点: [ 1.0 ] %              | |
|  | 超过此滑点的订单将被拒绝执行                              | |
|  +-----------------------------------------------------------+|
|                                                              |
|  技术风控                                                    |
|  +-----------------------------------------------------------+|
|  | API响应超时监控: [开关]   超时阈值: [ 2000 ] 毫秒         | |
|  | API响应超过此时间视为超时                                 | |
|  |                                                           | |
|  | 交易所连接状态监控: [开关]   重连尝试次数: [ 3 ]          | |
|  | 连接断开后自动尝试重连的次数                              | |
|  +-----------------------------------------------------------+|
|                                                              |
|  时间风控                                                    |
|  +-----------------------------------------------------------+|
|  | 交易时间限制: [开关]                                      | |
|  | 交易日: [周一][周二][周三][周四][周五][ ]周六[ ]周日      | |
|  |                                                           | |
|  | 交易开始时间: [09:00:00]   交易结束时间: [21:00:00]       | |
|  |                                                           | |
|  | 重要时间点禁止交易: [开关]                                | |
|  | [+ 添加/管理时间点]   已设置 0 个重要时间点               | |
|  +-----------------------------------------------------------+|
|                                                              |
|  [          保存配置          ][          重置默认值         ]|
|                                                              |
+--------------------------------------------------------------+
```

## 重要时间点管理弹窗

```
+--------------------------------------------------------------+
| 重要时间点管理                                          [X] |
+--------------------------------------------------------------+
|                                                              |
| +----------------------------------------------------------+ |
| | 名称            | 类型    | 开始时间        | 结束时间     | 操作  |
| |----------------|---------|----------------|--------------|------|
| | [非农数据发布]  | [一次性▼] | [2023-12-01][14:30] | [2023-12-01][15:30] | [删除] |
| | [央行利率决议]  | [永久▼]  | [15:00]           | -             | [删除] |
| +----------------------------------------------------------+ |
|                                                              |
| [+ 添加时间点]                                              |
|                                                              |
| 在设置的时间范围内将禁止交易                                |
| 永久类型的时间点会在每天指定时间段内禁止交易                |
|                                                              |
| [取消]                                          [保存]       |
+--------------------------------------------------------------+
```

## 风控触发历史弹窗

```
+--------------------------------------------------------------+
| 风控触发历史                                            [X] |
+--------------------------------------------------------------+
|                                                              |
| +----------------------------------------------------------+ |
| | 时间             | 触发类型    | 触发值     | 阈值      | 采取动作     | 影响范围   |
| |-----------------|------------|-----------|-----------|-------------|------------|
| | 2023-12-20 09:45| 单日亏损限制| 521 USDT  | 500 USDT  | 暂停所有策略 | 全部      |
| | 2023-12-19 15:20| API响应超时| 3500 毫秒  | 2000 毫秒 | 暂停币安交易 | 币安      |
| | 2023-12-18 13:12| 价格异常波动| 4.8%      | 3.0%      | 暂停BTC相关  | BTC交易对 |
| +----------------------------------------------------------+ |
|                                                              |
| << 1 2 3 ... >>                                             |
|                                                              |
+--------------------------------------------------------------+
```

## 技术实现
- 组件路径: `client/frontend/src/views/risk/RiskManagement.vue`
- 使用Vue 3的组合式API（Composition API）
- 使用Ant Design Vue组件库实现界面元素：
  - Card: 各风控模块区域
  - Form: 风控参数设置表单
  - InputNumber: 数值型参数输入
  - Switch: 功能开关控制
  - Select: 选项选择
  - TimePicker/DatePicker: 时间点设置
  - Modal: 弹窗管理
  - Table: 表格数据展示
  - Progress: 进度条可视化
  - Button: 操作按钮
  - Alert: 提示信息

## 数据模型
```typescript
// 账户安全风控
interface AccountRiskForm {
  lossLimit: number;          // 最大亏损限制金额
  timeUnit: 'hour' | 'day' | 'week';  // 时间单位
}

// 市场风险风控
interface MarketRiskForm {
  priceVolatilityMonitoring: boolean;  // 价格异常波动监控开关
  volatilityThreshold: number;         // 波动阈值百分比
  volatilityTimeWindow: number;        // 监控时间窗口数值
  volatilityTimeUnit: 'minute' | 'hour' | 'day';  // 时间窗口单位
  volatilityCalculationMethod: 'highLow' | 'standardDeviation' | 'atr';  // 波动计算方式
  liquidityMonitoring: boolean;        // 流动性监控开关
  maxAllowedSlippage: number;          // 最大允许滑点百分比
}

// 技术风控
interface TechRiskForm {
  apiTimeoutMonitoring: boolean;      // API响应超时监控开关
  apiTimeoutThreshold: number;        // API超时阈值(毫秒)
  exchangeConnMonitoring: boolean;    // 交易所连接状态监控开关
  autoReconnectAttempts: number;      // 自动重连尝试次数
}

// 时间风控
interface TimePoint {
  id: number;                // 时间点ID
  name: string;              // 时间点名称
  description: string;       // 描述
  timeType: 'oneTime' | 'permanent';  // 时间类型：一次性/永久
  startDate?: dayjs.Dayjs;   // 开始日期
  startTime?: dayjs.Dayjs;   // 开始时间
  endDate?: dayjs.Dayjs;     // 结束日期
  endTime?: dayjs.Dayjs;     // 结束时间
}

interface TimeRiskForm {
  tradingTimeLimit: boolean;  // 交易时间限制开关
  tradingDays: string[];      // 交易日设置
  tradingStartTime: dayjs.Dayjs;  // 交易开始时间
  tradingEndTime: dayjs.Dayjs;    // 交易结束时间
  timePointLimit: boolean;    // 时间点限制开关
  forbiddenTimePoints: TimePoint[];  // 禁止交易的时间点列表
}

// 风控历史记录
interface RiskHistoryRecord {
  id: number;
  time: string;            // 触发时间
  triggerType: string;     // 触发类型
  triggerValue: string;    // 触发值
  threshold: string;       // 阈值
  action: string;          // 采取的动作
  affectedScope: string;   // 影响范围
}
```

## 交互逻辑
1. **系统风控条件**：
   - 最大持仓币种数：设置为0表示不限制，否则限制最大同时持仓币种数量
   - 最大持仓价值：设置为0表示不限制，否则限制总持仓价值
   - 最大亏损停止：设置为0表示不限制，否则在亏损达到此金额时停止所有策略

2. **紧急停止**：
   - 点击"紧急停止所有交易"按钮立即暂停所有正在运行的交易策略
   - 适用于极端市场情况或系统异常时的快速响应

3. **账户安全风控**：
   - 设置单位时间内的最大亏损金额
   - 可选择按小时、每日或每周计算
   - 触发时自动暂停相关策略

4. **市场风险风控**：
   - 价格异常波动监控：监测短时间内的价格异常变动
   - 波动阈值设置：配置触发保护的波动百分比
   - 时间窗口配置：设置监控的时间范围和单位
   - 波动计算方式：选择不同的波动率计算方法
   - 流动性监控：监控交易对流动性和控制最大滑点

5. **技术风控**：
   - API响应监控：检测交易所API响应时间
   - 连接状态监控：监控网络连接状态
   - 自动重连配置：设置连接中断后的重连尝试次数

6. **时间风控**：
   - 交易时间限制：设置允许交易的日期和时间段
   - 重要时间点管理：添加、编辑和删除特定时间点
   - 一次性/永久时间点：灵活配置不同类型的时间规则

7. **设置保存**：
   - 保存配置：将所有风控设置保存到系统
   - 重置默认值：一键恢复所有设置为系统默认值

## 注意事项
1. **风控优先级**：
   - 紧急停止功能具有最高优先级，会覆盖其他设置
   - 系统级风控条件优先于单项风控设置

2. **参数验证**：
   - 所有数值参数需在合理范围内设置
   - 时间设置需验证开始时间早于结束时间
   - 时间点设置需提供必要的名称和时间信息

3. **风控触发后果**：
   - 不同风控触发后会采取相应的保护措施
   - 可能包括暂停特定策略、限制下单或全面停止交易

4. **风控历史分析**：
   - 定期查看风控触发历史以优化风控参数
   - 分析触发原因和影响范围以改进风控策略

5. **用户交互反馈**：
   - 所有设置变更提供即时反馈
   - 重要操作如删除时间点需二次确认
   - 参数设置不合理时提供警告提示 