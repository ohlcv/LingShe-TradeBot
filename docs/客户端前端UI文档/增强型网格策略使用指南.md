# 增强型网格策略使用指南

本文档将详细介绍增强型网格策略的功能、参数设置和使用方法，帮助交易者充分利用该策略进行加密货币交易。

## 1. 策略概述

增强型网格策略是基于传统网格交易策略的升级版本，通过多层分批止盈、开仓反弹和全面风控机制，提供更灵活、更智能的交易体验。该策略适用于波动市场，通过在不同价格层级设置买入和卖出订单，实现"低买高卖"的交易目标。

### 主要特点

- **多层级网格**：可设置多个价格层级，每层配置不同的投资金额
- **分批止盈**：支持对每个网格层级设置多批次止盈，实现利润最大化
- **开仓反弹**：支持设置反弹确认开仓，避免追踪下跌
- **实时风控**：全面的风控系统，保护资金安全
- **状态可视化**：直观展示每个网格层级的状态
- **动态参数调整**：支持在策略运行过程中动态调整网格层级和参数
- **动态网格**：支持根据市场情况自动调整网格配置

## 2. 参数详解

### 基本参数

| 参数名           | 说明             | 默认值            | 示例              |
| ---------------- | ---------------- | ----------------- | ----------------- |
| connector_name   | 交易所连接器名称 | binance_perpetual | binance_perpetual |
| trading_pair     | 交易对           | BTC-USDT          | ETH-USDT          |
| position_mode    | 仓位模式         | HEDGE             | HEDGE/ONEWAY      |
| leverage         | 杠杆倍数         | 3                 | 5                 |
| total_investment | 总投资金额(USDT) | 1000              | 2000              |

### 网格层级参数

每个网格层级包含以下参数：

| 参数名             | 说明                | 示例   |
| ------------------ | ------------------- | ------ |
| level              | 层级编号（从1开始） | 1      |
| amount             | 该层级的投资金额    | 100    |
| open_ratio         | 开仓间隔比例（%）   | 2.0    |
| open_rebound_ratio | 开仓反弹比例（%）   | 0.3    |
| is_active          | 是否激活该层级      | true   |
| status             | 层级状态（只读）    | 未开仓 |

### 止盈批次参数

每个层级可以设置多个止盈批次：

| 参数名        | 说明                | 示例   |
| ------------- | ------------------- | ------ |
| level         | 批次级别（从1开始） | 1      |
| profit_ratio  | 止盈比例（%）       | 1.5    |
| rebound_ratio | 回调比例（%）       | 0.3    |
| portion       | 平仓比例（%）       | 50     |
| status        | 状态（只读）        | 未触发 |

### 风控参数

| 参数名                        | 说明                       | 默认值   |
| ----------------------------- | -------------------------- | -------- |
| total_loss_limit              | 总亏损停止阈值（计价货币） | 500      |
| total_profit_limit            | 总盈利停止阈值（计价货币） | 1000     |
| max_loss_per_trade            | 单笔最大亏损额             | 50       |
| max_position                  | 最大持仓金额               | 1000     |
| trading_time_limit            | 交易时间限制               | false    |
| trading_start_time            | 交易开始时间               | 09:00:00 |
| trading_end_time              | 交易结束时间               | 23:00:00 |
| consecutive_loss_limit        | 连续亏损限制               | 5        |
| order_frequency_limit         | 下单频率限制               | 10       |
| price_volatility_protection   | 价格波动保护               | true     |
| volatility_adjusted_stop_loss | 波动率调整止损             | true     |
| hedging_protection            | 对冲保护                   | false    |

### 动态网格参数

| 参数名              | 说明               | 默认值 |
| ------------------- | ------------------ | ------ |
| enable_dynamic_grid | 启用动态网格调整   | true   |
| max_grid_levels     | 最大网格层级数     | 10     |
| update_interval     | 策略更新间隔（秒） | 30     |

## 3. 工作原理

### 网格创建逻辑

1. **初始网格定位**：策略启动时，获取当前市场中间价格作为参考点
2. **网格层级计算**：
   - 第一层级价格 = 中间价格
   - 第二层级价格 = 第一层级价格 * (1 - 层级开仓间隔比例/100)
   - 第三层级价格 = 第二层级价格 * (1 - 层级开仓间隔比例/100)
   - 依此类推...

### 开仓逻辑

1. **直接开仓**：当价格下跌到网格层级价格时，在该价格创建限价买单
2. **反弹开仓**：当价格跌破网格层级价格后，反弹回升至(网格层级价格 * (1 - 反弹比例/100))时触发开仓

### 止盈逻辑

1. **分批平仓**：按照预设的批次依次止盈
2. **回调确认**：支持设置价格回调确认后再止盈，避免错过大行情
3. **比例平仓**：可为每个批次设置不同的平仓比例

### 风控机制

1. **资金风控**：总亏损限制、单笔亏损限制等
2. **时间风控**：交易时间段限制
3. **交易保护**：连续亏损限制、下单频率限制等
4. **智能风控**：波动率调整止损、对冲保护等

### 动态网格调整

1. **网格层级动态添加删除**：可以在策略运行过程中添加或删除网格层级
2. **实时参数更新**：大多数参数可实时修改，无需重启策略
3. **已激活层级安全更新**：对于已开仓的网格层级，系统会保护关键参数，只允许修改非关键参数如止盈设置

## 4. 策略使用示例

### 场景一：标准网格策略（均匀分布）

适用于震荡市场，网格均匀分布，每层投资金额相同：

```json
"grid_levels": [
  {
    "level": 1,
    "amount": 100,
    "open_ratio": 1.0,
    "open_rebound_ratio": 0.2,
    "is_active": true
  },
  {
    "level": 2,
    "amount": 100,
    "open_ratio": 1.0,
    "open_rebound_ratio": 0.2,
    "is_active": true
  },
  {
    "level": 3,
    "amount": 100,
    "open_ratio": 1.0,
    "open_rebound_ratio": 0.2,
    "is_active": true
  }
]
```

### 场景二：金字塔网格策略（逐层加仓）

适用于下跌趋势市场，价格越低投资越多：

```json
"grid_levels": [
  {
    "level": 1,
    "amount": 100,
    "open_ratio": 1.5,
    "open_rebound_ratio": 0.3,
    "is_active": true
  },
  {
    "level": 2,
    "amount": 200,
    "open_ratio": 2.0,
    "open_rebound_ratio": 0.3,
    "is_active": true
  },
  {
    "level": 3,
    "amount": 300,
    "open_ratio": 2.5,
    "open_rebound_ratio": 0.4,
    "is_active": true
  }
]
```

### 场景三：多批次止盈策略

适用于波动较大的市场，设置多个止盈点：

```json
"grid_levels": [
  {
    "level": 1,
    "amount": 200,
    "open_ratio": 2.0,
    "open_rebound_ratio": 0.3,
    "take_profit_batches": [
      {
        "level": 1,
        "profit_ratio": 1.0,
        "rebound_ratio": 0.2,
        "portion": 30
      },
      {
        "level": 2,
        "profit_ratio": 2.0,
        "rebound_ratio": 0.3,
        "portion": 30
      },
      {
        "level": 3,
        "profit_ratio": 3.0,
        "rebound_ratio": 0.5,
        "portion": 40
      }
    ],
    "is_active": true
  }
]
```

## 5. 策略状态跟踪

网格层级有四种状态：

- **未开仓**：初始状态，未触发开仓条件
- **待开仓**：触发开仓条件，已创建买单但未成交
- **已开仓**：买单已成交，建立了仓位
- **待止盈**：已开仓并且有部分仓位已平仓

止盈批次有两种状态：

- **未触发**：初始状态，未达到止盈条件
- **已触发**：已达到止盈条件，仓位已部分或全部平仓

## 6. 动态参数调整

系统支持在策略运行过程中调整以下参数：

### 可完全自由调整的参数

- 风控参数（全部）
- 动态网格配置
- 全局止盈设置
- 基本参数（交易对、杠杆等）

### 未开仓层级可调整参数

- 所有参数均可调整

### 已开仓层级可调整参数

- 是否激活（可以停用但不能删除）
- 止盈批次配置

### 层级管理

- 可以随时添加新的网格层级
- 未开仓的层级可以删除
- 已开仓的层级可以停用但不能删除
- 网格层级数有上限，超过上限时会保留优先级最高的层级

## 7. 最佳实践

1. **合理设置网格间距**：根据交易对的波动特性设置合适的开仓间隔比例
2. **梯度分配资金**：价格越低，可适当增加投资金额
3. **设置多批次止盈**：分批止盈可以兼顾短期收益和长期潜力
4. **开启波动率调整止损**：在高波动环境中能够提供更好的保护
5. **启用动态网格调整**：让策略能够根据市场情况自适应调整
6. **定期检查策略表现**：根据市场情况调整参数

## 8. 策略局限性

1. 在强趋势市场（尤其是单向上涨）中，表现可能不如趋势跟踪策略
2. 需要较大的资金储备以覆盖多个网格层级
3. 参数设置复杂，需要经验和不断调整

## 9. 常见问题

### Q: 如何确定合适的网格间距？
A: 可根据交易对的平均日波动率来确定。一般来说，网格间距应为日波动率的1/4到1/3。

### Q: 什么是开仓反弹比例？
A: 开仓反弹比例是指价格跌破网格价格后，需要反弹多少比例才触发开仓。这有助于避免在单边下跌市场中过早开仓。

### Q: 如何设置合理的止盈批次？
A: 建议将止盈分为3-4个批次，第一批次设置较低的止盈点（如1-2%），最后批次设置较高的止盈点（如5-10%）。

### Q: 策略适合哪些市场条件？
A: 该策略最适合区间震荡的市场，或者是缓慢下跌后预期会反弹的市场。

### Q: 已开仓的网格层级可以调整哪些参数？
A: 已开仓的网格层级只能调整止盈设置和激活状态，不能调整投资金额和开仓相关参数。

### Q: 如何动态调整网格层级？
A: 您可以随时添加新的网格层级，或删除未开仓的层级。如果要修改已开仓层级，可以先停用它（设置is_active为false），然后添加新配置的层级。

## 10. 附录：完整配置示例

```json
{
  "controller_name": "enhanced_grid",
  "controller_type": "generic",
  "candles_config": [
    {
      "connector": "binance_perpetual",
      "trading_pair": "BTC-USDT",
      "interval": "1m",
      "max_records": 500
    }
  ],
  "connector_name": "binance_perpetual",
  "trading_pair": "BTC-USDT",
  "position_mode": "HEDGE",
  "leverage": 3,
  "total_investment": 1000,
  "grid_levels": [
    {
      "level": 1,
      "amount": 100,
      "open_ratio": 1.0,
      "open_rebound_ratio": 0.2,
      "take_profit_batches": [
        {
          "level": 1,
          "profit_ratio": 1.5,
          "rebound_ratio": 0.3,
          "portion": 50
        },
        {
          "level": 2,
          "profit_ratio": 3.0,
          "rebound_ratio": 0.5,
          "portion": 50
        }
      ],
      "is_active": true
    },
    {
      "level": 2,
      "amount": 150,
      "open_ratio": 2.0,
      "open_rebound_ratio": 0.3,
      "take_profit_batches": [
        {
          "level": 1,
          "profit_ratio": 1.5,
          "rebound_ratio": 0.3,
          "portion": 50
        },
        {
          "level": 2,
          "profit_ratio": 3.0,
          "rebound_ratio": 0.5,
          "portion": 50
        }
      ],
      "is_active": true
    }
  ],
  "risk_control": {
    "total_loss_limit": 500,
    "total_profit_limit": 1000,
    "max_loss_per_trade": 50,
    "max_position": 1000,
    "trading_time_limit": false,
    "trading_start_time": "09:00:00",
    "trading_end_time": "23:00:00",
    "consecutive_loss_limit": 5,
    "order_frequency_limit": 10,
    "price_volatility_protection": true,
    "volatility_adjusted_stop_loss": true,
    "hedging_protection": false
  },
  "update_interval": 30,
  "enable_dynamic_grid": true,
  "max_grid_levels": 10
}
``` 