# 网格策略设置页面

## 页面概述
网格策略设置页面是用户配置和管理网格交易策略的核心界面，提供丰富的参数设置选项，包括网格层级、开仓条件、止盈策略等关键配置。用户可以通过此页面创建和编辑高度定制化的网格交易策略，实现根据价格波动自动买卖的交易逻辑。页面采用步骤式导航，引导用户完成网格策略的完整配置过程。

## 功能点
1. **策略步骤导航**：以步骤形式引导用户完成整个策略配置
   - 基本设置（第1步）
   - 策略参数（第2步，当前页面）
   - 策略风控（第3步）
   - 完成（第4步）

2. **网格层级配置**：
   - 投资张数和网格数量设置
   - 自动生成网格层级功能
   - 手动调整各网格层的参数
   - 层级状态管理（已开仓、待止盈、待开仓、未开仓）

3. **多层分批止盈设置**：
   - 设置每个网格层级的分批止盈参数
   - 支持多批次止盈，防止杀跌
   - 可配置止盈比例、回调比例、平仓比例
   - 设置每批止盈的状态跟踪

4. **总体持仓止盈配置**：
   - 基于当前平均持仓成本的总体止盈
   - 多层分批止盈机制
   - 触发条件满足时平掉全部仓位

5. **交易记录查看**：已开仓和待止盈的网格层支持查看交易历史

## 用户流程
1. 用户在完成基本设置（交易所、交易对选择等）后进入策略参数页面
2. 配置投资张数和网格数量，点击"自动生成网格层级"
3. 根据需要调整各网格层级的参数，包括：
   - 开仓间隔比例
   - 开仓反弹比例
   - 层级止盈设置（多层分批）
4. 设置总体持仓止盈参数
5. 点击"下一步"进入策略风控
6. 完成策略风控后保存并激活策略

## 线框图

```
+--------------------------------------------------------------+
|                                                              |
|  +------------------------------------------------------+    |
|  |                     策略步骤导航                      |    |
|  | [✓]基本设置 --> [2]策略参数 --> [3]策略风控 --> [4]完成 |    |
|  +------------------------------------------------------+    |
|                                                              |
|  网格策略设置                                                |
|                                                              |
|  +------------------------------------------------------+    |
|  | 网格层级设置                                    [?]  |    |
|  |                                                      |    |
|  | +--------+ +----------+                             |    |
|  | |投资张数:| |网格数量:  | [自动生成网格层级]          |    |
|  | | [100 ] | | [5     ] |                             |    |
|  | +--------+ +----------+                             |    |
|  |                                                      |    |
|  | +---+--------+------+--------+----------+-----------+------+    |
|  | |层级|  状态  |张数  |开仓间隔%|开仓反弹%|   止盈    | 操作 |    |
|  | +---+--------+------+--------+----------+-----------+------+    |
|  | | 1 |已开仓  | 20   |  1.0   |   0.5    | 3层止盈   |交易记录|    |
|  | | 2 |待止盈  | 20   |  1.0   |   0.5    | 3层止盈   |交易记录|    |
|  | | 3 |待开仓  | 20   |  1.0   |   0.5    |[设置止盈] | 删除  |    |
|  | | 4 |未开仓  | 20   |  1.0   |   0.5    |[设置止盈] | 删除  |    |
|  | | 5 |未开仓  | 20   |  1.0   |   0.5    |[设置止盈] | 删除  |    |
|  | +---+--------+------+--------+----------+-----------+------+    |
|  |                                                      |    |
|  | [+ 添加网格层级]                                       |    |
|  +------------------------------------------------------+    |
|                                                              |
|  +------------------------------------------------------+    |
|  | 总体持仓设置                                    [?]  |    |
|  |                                                      |    |
|  | 当前设置: [已设置 3层分批止盈]      [修改总体止盈]    |    |
|  |                                                      |    |
|  | 总体持仓概览:                                         |    |
|  | +------------+ +------------+ +------------+ +-------+    |
|  | |当前持仓层数 | |总持仓张数  | |当前收益   | |止盈批次|    |
|  | |     2      | |    40     | |  +2.35%   | |   3    |    |
|  | +------------+ +------------+ +------------+ +-------+    |
|  +------------------------------------------------------+    |
|                                                              |
|  [上一步]                                      [下一步]      |
|                                                              |
+--------------------------------------------------------------+
```

## 网格层级止盈设置弹窗

```
+------------------------------------------+
| 分批止盈设置                           X |
+------------------------------------------+
| 网格层级: 3                              |
| 当前状态: 待开仓                         |
|                                          |
| +----+--------+--------+---------+------+|
| |批次| 止盈间隔% | 回调间隔% | 平仓比例  | 操作 ||
| +----+--------+--------+---------+------+|
| | 1  |   1.0   |   0.5   |   30%   | 删除 ||
| | 2  |   1.5   |   0.5   |   30%   | 删除 ||
| | 3  |   2.0   |   0.5   |   40%   | 删除 ||
| +----+--------+--------+---------+------+|
|                                          |
| 总平仓比例必须等于100%                    |
|                                          |
| [+ 添加止盈批次]                         |
|                                          |
| [取消]                      [确定]       |
+------------------------------------------+
```

## 总体持仓止盈设置弹窗

```
+------------------------------------------+
| 总体持仓止盈设置                       X |
+------------------------------------------+
| 止盈说明: 总体持仓止盈基于当前平均持仓成本 |
| 进行计算，触发条件满足时将平掉全部仓位     |
|                                          |
| 注意: 所有批次平仓比例总和必须等于100%    |
|                                          |
| +----+--------+--------+---------+------+|
| |批次| 止盈间隔% | 回调间隔% | 平仓比例  | 操作 ||
| +----+--------+--------+---------+------+|
| | 1  |   1.0   |   0.5   |   20%   | 删除 ||
| | 2  |   2.0   |   0.5   |   30%   | 删除 ||
| | 3  |   3.0   |   1.0   |   50%   | 删除 ||
| +----+--------+--------+---------+------+|
|                                          |
| 总平仓比例必须等于100%                    |
|                                          |
| [+ 添加止盈批次]                         |
|                                          |
| [取消]                      [确定]       |
+------------------------------------------+
```

## 技术实现
- 组件路径: `client/frontend/src/views/strategies/grid/GridStrategyView.vue`
- 使用Ant Design Vue的表格、表单、卡片、弹窗等组件
- 采用Vue 3的组合式API（Composition API）构建
- 使用reactive和ref管理响应式状态
- 使用路由参数传递策略配置信息到下一步

## 数据模型
### 网格层级结构 (GridLevel)
```typescript
interface GridLevel {
    key: number;
    level: number;            // 层级编号
    openReboundRatio: number; // 开仓反弹比例
    openRatio: number;        // 开仓间隔比例
    size: number;             // 层级张数
    status: string;           // 层级状态 (已开仓/待止盈/待开仓/未开仓)
    editable: boolean;        // 是否可编辑
    takeProfitLevels: TakeProfitLevel[]; // 止盈设置
}
```

### 止盈层级结构 (TakeProfitLevel)
```typescript
interface TakeProfitLevel {
    key: number;
    level: number;        // 批次编号
    ratio: number;        // 止盈比例
    reboundRatio: number; // 回调比例
    portion: number;      // 平仓比例
    status?: string;      // 止盈状态
}
```

### 网格策略表单
```typescript
const gridForm = {
    gridCount: number,    // 网格数量
    investment: number,   // 投资张数
    takeProfitType: string // 止盈类型
}
```

## 交互逻辑
1. **网格层级生成**：
   - 用户设置投资张数和网格数量后，点击"自动生成网格层级"
   - 系统根据输入参数计算并生成均匀分布的网格层级
   - 每个层级初始设置相同的开仓间隔、反弹比例和张数

2. **层级止盈设置**：
   - 点击层级的"设置止盈"按钮，打开止盈设置弹窗
   - 可添加多批次止盈，并设置各批次的止盈比例、回调比例和平仓比例
   - 所有批次的平仓比例之和必须为100%
   - 保存时会进行校验，确保设置有效

3. **总体持仓止盈**：
   - 点击"设置总体止盈"按钮，打开总体止盈设置弹窗
   - 设置基于平均持仓成本的多批次止盈
   - 所有批次平仓比例总和必须为100%
   - 保存后可在总体持仓概览中查看相关统计信息

4. **表格状态显示**：
   - 已开仓和待止盈状态的层级显示为灰色背景，表示只读状态
   - 不同状态使用不同颜色的标签区分：
     - 已开仓：红色
     - 待止盈：绿色
     - 待开仓：蓝色
     - 未开仓：灰色
   - 已开仓和待止盈的层级提供"交易记录"查看功能而非"删除"功能

## 注意事项
1. **层级状态限制**：
   - 已开仓和待止盈状态的网格层被锁定为只读，不可编辑或删除
   - 保护已执行交易的层级参数不被修改，确保策略稳定性

2. **参数验证规则**：
   - 网格数量最小为2，最大为50
   - 投资张数最小为1
   - 开仓间隔和反弹比例最小为0.1%
   - 所有止盈批次的平仓比例总和必须等于100%

3. **响应式设计**：
   - 适配不同屏幕尺寸，提供良好的移动设备体验
   - 表格内容在小屏幕上自动调整

4. **交互提示**：
   - 为复杂参数提供悬浮提示说明
   - 表单验证错误时显示明确的错误信息
   - 操作成功或失败时显示反馈提示

5. **数据传递**：
   - 完成配置后，将策略参数通过URL查询参数传递到下一步
   - 包括网格配置、网格层级和全局止盈设置等完整数据 