# 策略风控页面

## 页面概述
策略风控页面是创建交易策略的第三步，专注于设置风险控制和交易保护参数，帮助用户在策略运行过程中控制风险、避免重大亏损。通过合理的风控设置，用户可以在自动化交易过程中保护资金安全，提高长期盈利的可能性。

## 功能点
1. **策略步骤导航**：
   - 清晰显示当前处于策略创建的第3步
   - 前两步（基本设置、策略参数）显示为已完成状态
   - 可通过点击步骤导航回到之前的配置步骤

2. **资金风控**：
   - 总亏损停止阈值设置
   - 总盈利停止阈值设置
   - 单笔最大亏损额限制
   - 最大持仓金额限制

3. **时间风控**：
   - 交易时间限制（仅在特定时段内交易）
   - 交易开始和结束时间设置
   - 重要时间点禁止交易选项
   - 重要时间点管理功能

4. **交易保护**：
   - 连续亏损限制
   - 连续亏损时间窗口设置
   - 下单频率限制
   - 价格波动保护

5. **智能风控**：
   - 波动率调整止损
   - 对冲保护选项
   - 风险评分显示

## 用户流程
1. 用户完成策略参数配置后进入策略风控页面
2. 设置资金风控参数
   - 配置总亏损和总盈利停止阈值
   - 设置单笔最大亏损额
   - 限制最大持仓金额
3. 配置时间风控限制
   - 启用/禁用交易时间限制
   - 设置交易时间段
   - 管理重要时间点禁止交易
4. 设置交易保护参数
   - 配置连续亏损限制
   - 设置下单频率限制
   - 启用价格波动保护
5. 调整智能风控选项
6. 点击"下一步"进入完成页面

## 线框图

```
+--------------------------------------------------------------+
|                                                              |
|  +------------------------------------------------------+    |
|  |                     策略步骤导航                      |    |
|  | [✓]基本设置 --> [✓]策略参数 --> [3]策略风控 --> [4]完成 |    |
|  +------------------------------------------------------+    |
|                                                              |
|  策略风控                                                    |
|                                                              |
|  +------------------------------------------------------+    |
|  | 资金风控                                             |    |
|  |                                                      |    |
|  | +------------------------+  +----------------------+ |    |
|  | | 总亏损停止阈值:         |  | 总盈利停止阈值:       | |    |
|  | | [1000] USDT            |  | [5000] USDT          | |    |
|  | | (策略总亏损达到该金额时自动停止) | (策略总盈利达到该金额时自动停止) | |    |
|  | +------------------------+  +----------------------+ |    |
|  |                                                      |    |
|  | +------------------------+  +----------------------+ |    |
|  | | 单笔最大亏损额:         |  | 最大持仓金额:         | |    |
|  | | [100] USDT             |  | [10000] USDT         | |    |
|  | | (单笔交易允许的最大亏损金额) | (策略允许的最大持仓金额) | |    |
|  | +------------------------+  +----------------------+ |    |
|  +------------------------------------------------------+    |
|                                                              |
|  +------------------------------------------------------+    |
|  | 时间风控                                             |    |
|  |                                                      |    |
|  | +------------------------+                           |    |
|  | | 交易时间限制: [开启]    |                           |    |
|  | | (仅在特定时间段内允许交易)                           |    |
|  | +------------------------+                           |    |
|  |                                                      |    |
|  | +------------------------+  +----------------------+ |    |
|  | | 交易开始时间:           |  | 交易结束时间:         | |    |
|  | | [09:30:00]             |  | [16:00:00]           | |    |
|  | +------------------------+  +----------------------+ |    |
|  |                                                      |    |
|  | +------------------------+                           |    |
|  | | 重要时间点禁止交易: [开启]                          |    |
|  | +------------------------+                           |    |
|  |                                                      |    |
|  | [添加/管理时间点] (已设置3个重要时间点)               |    |
|  +------------------------------------------------------+    |
|                                                              |
|  +------------------------------------------------------+    |
|  | 交易保护                                             |    |
|  |                                                      |    |
|  | +------------------------+  +----------------------+ |    |
|  | | 连续亏损限制:           |  | 连续亏损时间窗口:     | |    |
|  | | [3] 次                 |  | [24] 小时            | |    |
|  | +------------------------+  +----------------------+ |    |
|  |                                                      |    |
|  | +------------------------+  +----------------------+ |    |
|  | | 下单频率限制:           |  | 价格波动保护:         | |    |
|  | | [5] 次/分钟            |  | [开启]                | |    |
|  | +------------------------+  +----------------------+ |    |
|  +------------------------------------------------------+    |
|                                                              |
|  +------------------------------------------------------+    |
|  | 智能风控                                             |    |
|  |                                                      |    |
|  | +------------------------+  +----------------------+ |    |
|  | | 波动率调整止损: [开启]  |  | 对冲保护: [关闭]      | |    |
|  | +------------------------+  +----------------------+ |    |
|  |                                                      |    |
|  | 当前风险评分: 中等                                    |    |
|  +------------------------------------------------------+    |
|                                                              |
|  [上一步]                                    [下一步]        |
|                                                              |
+--------------------------------------------------------------+
```

## 重要时间点弹窗

```
+------------------------------------------+
| 重要时间点管理                         X |
+------------------------------------------+
| 说明: 在这些时间点前后的特定时间内，策略 |
| 将暂停交易，以避免高波动性风险。        |
|                                          |
| +----+--------+--------+--------------+ |
| |名称|  时间   | 前段禁止 | 后段禁止    | |
| +----+--------+--------+--------------+ |
| |开盘| 09:30  |  15分钟 |   5分钟     | |
| |收盘| 16:00  |  10分钟 |   0分钟     | |
| |数据| 08:30  |   5分钟 |   5分钟     | |
| +----+--------+--------+--------------+ |
|                                          |
| [+ 添加时间点]                           |
|                                          |
| [取消]                      [确定]       |
+------------------------------------------+
```

## 技术实现
- 组件路径: `client/frontend/src/views/strategies/risk/StrategyRiskView.vue`
- 使用Vue 3的组合式API（Composition API）构建
- 使用Ant Design Vue的表单、卡片、开关等组件
- 使用路由来导航不同步骤
- 使用store保存策略风控，传递到下一步

## 数据模型
```typescript
// 风控表单数据结构
interface RiskForm {
  // 资金风控
  totalLossLimit: number;        // 总亏损停止阈值
  totalProfitLimit: number;      // 总盈利停止阈值
  maxLossPerTrade: number;       // 单笔最大亏损额
  maxPosition: number;           // 最大持仓金额

  // 时间风控
  tradingTimeLimit: boolean;     // 交易时间限制开关
  tradingStartTime: Date | null; // 交易开始时间
  tradingEndTime: Date | null;   // 交易结束时间
  timePointLimit: boolean;       // 重要时间点禁止交易开关
  forbiddenTimePoints: TimePoint[]; // 禁止交易的时间点

  // 交易保护
  consecutiveLossLimit: number;  // 连续亏损限制
  consecutiveLossWindow: number; // 连续亏损时间窗口
  consecutiveLossWindowUnit: string; // 时间窗口单位(分钟/小时/天)
  orderFrequencyLimit: number;   // 下单频率限制
  orderFrequencyWindow: string;  // 下单频率时间窗口
  priceVolatilityProtection: boolean; // 价格波动保护开关

  // 智能风控
  volatilityAdjustedStopLoss: boolean; // 波动率调整止损开关
  hedgingProtection: boolean;   // 对冲保护开关
}

// 时间点结构
interface TimePoint {
  id: number;
  name: string;          // 时间点名称
  time: string;          // 时间 (HH:mm)
  beforeMinutes: number; // 前段禁止交易分钟数
  afterMinutes: number;  // 后段禁止交易分钟数
}
```

## 交互逻辑
1. **风控参数设置**：
   - 提供数字输入框设置金额和次数限制
   - 使用开关控制功能启用/禁用
   - 对关键字段提供tooltips说明

2. **时间控制**：
   - 交易时间限制启用后显示时间选择器
   - 重要时间点管理通过模态窗口实现
   - 支持添加、编辑和删除重要时间点

3. **表单验证**：
   - 确保数值型输入在合理范围内
   - 验证开始时间早于结束时间
   - 检查必填项完整性

4. **风险评分**：
   - 基于设置的风控参数计算风险评分
   - 评分分为低、中、高三级
   - 实时更新评分，帮助用户调整参数

## 注意事项
1. **默认值设置**：
   - 提供合理的默认风控参数
   - 资金限制根据策略规模默认为相应比例

2. **易用性设计**：
   - 分类展示风控选项，便于理解
   - 为复杂选项提供说明文字
   - 使用开关组件简化开启/关闭功能

3. **性能考虑**：
   - 时间点管理模块使用虚拟滚动处理大量数据
   - 避免频繁重计算风险评分

4. **用户提示**：
   - 设置过于严格的限制时提供友好提示
   - 参数设置异常时显示警告信息

5. **数据传递**：
   - 配置完成后将风控参数传递到策略创建最后一步
   - 支持用户返回修改参数，保持数据连续性 